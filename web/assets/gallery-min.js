"use strict";const navigation=function(e,t){document.addEventListener("keydown",(a=>{switch(a.key){case"ArrowRight":a.preventDefault(),selectItem("next",e,t);break;case"ArrowLeft":a.preventDefault(),selectItem("previous",e,t);break;case"ArrowUp":a.preventDefault(),selectItem("up",e,t);break;case"ArrowDown":a.preventDefault(),selectItem("down",e,t);break;case"i":a.metaKey&&(a.preventDefault(),"gallery"==e.id&&document.getElementById("index").click());break;case"f":a.preventDefault(),toggleFullScreen()}if("albums"!=e.id)switch(a.key){case"Backspace":a.preventDefault(),hideSlideshow();break;case" ":if(a.preventDefault(),isSlideshowActive)return void hideSlideshow();showSlideshow();break;case"Escape":return void(isSlideshowActive&&(a.preventDefault(),hideSlideshow()));case"d":if(a.preventDefault(),a.metaKey)return void document.getElementById("show-marked").click();toggleMarkedImage(),checkIfImageIsMarked()}}),!1),e.addEventListener("focus",(e=>{currentImage=e.target.closest("a"),currentImage.dataset.active=!0}),!0),e.addEventListener("blur",(e=>{e.target.closest("a").dataset.active=!1}),!0),"albums"!=e.id&&document.addEventListener("click",(a=>{(e.contains(a.target)||slideshow.contains(a.target))&&"BODY"!=a.target.parentElement.tagName&&(a.preventDefault(),0==isSlideshowActive?(currentImage=a.target,"A"!=a.target.nodeName&&(currentImage=a.target.closest("a")),showSlideshow()):"BUTTON"==a.target.nodeName?hideSlideshow():selectItem("next",e,t))}))},selectItem=function(e,t,a){let n;currentImage=""==currentImage?t.querySelector("a"):currentImage;let r=currentImage.closest("li");switch(e){case"up":for(let e=0;e<a;e++){let e=r.previousElementSibling;if(!e)break;r=e}break;case"down":for(let e=0;e<a;e++){let e=r.nextElementSibling;if(!e)break;r=e}n=r.querySelector("a");break;case"previous":r=r.previousElementSibling;break;case"next":r=currentImage.closest("li").nextElementSibling}r&&(n=r.querySelector("a"),currentImage=n,isSlideshowActive&&(checkIfImageIsMarked(),slideshowImage.src=currentImage.querySelector("img").src),0==isSlideshowActive&&setFocusOnCurrentImage())},calcColumns=function(e){return window.getComputedStyle(e,null).getPropertyValue("grid-template-columns").split(" ").length},setFocusOnCurrentImage=function(){currentImage.dataset.active=!0,currentImage.focus()};let slideshow,slideshowImage,currentImage="",isSlideshowActive=!1;const createSlideshowOverlay=function(e){slideshow=document.createElement("div"),slideshow.id="slideshow",slideshow.className="slideshow",e.after(slideshow),slideshowImage=document.createElement("img"),slideshowImage.id="img",slideshow.appendChild(slideshowImage);const t=document.createElement("button");t.innerHTML='Close <span class="shortcut">ESC</span>',t.className="btn",slideshow.appendChild(t);const a=document.createElement("button");a.innerHTML='Fullscreen <span class="shortcut">F</span>',a.className="btn",slideshow.appendChild(a),slideshow.dataset.active=!1},showSlideshow=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:currentImage;slideshowImage.src=e.querySelector("img").src,checkIfImageIsMarked(),slideshow.dataset.active=!0,isSlideshowActive=!0},hideSlideshow=function(){slideshow.dataset.active=!1,setFocusOnCurrentImage(),isSlideshowActive=!1},toggleFullScreen=function(){!document.fullscreenElement&&isSlideshowActive?slideshow.requestFullscreen():document.exitFullscreen&&document.exitFullscreen()},checkIfImageIsMarked=function(){slideshowImage.dataset.marked=currentImage.dataset.marked,currentImage.focus()},toggleMarkedImage=function(){if("true"===currentImage.dataset.marked)return currentImage.dataset.marked=slideshowImage.dataset.marked="false",void localStorage.removeItem(currentImage.id);currentImage.dataset.marked=slideshowImage.dataset.marked="true",localStorage.setItem(currentImage.id,"true")},getMarkImagesFromStorage=function(){Object.keys(localStorage).forEach((e=>{const t=document.getElementById(e);t&&(t.dataset.marked="true")}))},createMarkedImagesArray=function(e){const t=e.querySelectorAll("a[data-marked=true] img");return Array.from(t).map((e=>new URL(e.src)))},createMarkedImagesList=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0;if(null===e&&(e=createMarkedImagesArray(t)),0==e.length)return;let a="<ul>";return e.forEach((e=>{a+='<li><img class="preview" src="'+e+'" /></li>'})),a+="</ul>",a},showMarkedImagesDialog=function(e){const t=document.getElementById("markedImagesDialog"),a=t.getElementsByClassName("content")[0],n=t.getElementsByTagName("form")[0];let r="";const s=createMarkedImagesArray(e),l=createMarkedImagesList(s,e);if(s.length){r=l;let e=document.getElementById("markedImagesInput");e.value=s,n.appendChild(e)}else r="<p>No marked image yet!</p>";a.innerHTML=r;n.querySelector(".btn.cancel").addEventListener("click",(e=>{e.preventDefault(),t.close()}),!1),t.showModal()},initMarkedImages=function(e){getMarkImagesFromStorage(),document.getElementById("mark-file").addEventListener("click",(function(e){e.preventDefault(),toggleMarkedImage(),checkIfImageIsMarked()}),!1),document.getElementById("show-marked").addEventListener("click",(function(t){t.preventDefault(),showMarkedImagesDialog(e)}),!1)},deleteMarkedImages=function(){const e=document.getElementById("markedImagesDialog"),t=e.getElementsByTagName("form")[0];let a=document.createElement("button");a.type="submit",a.id="delete-marked-images",a.innerHTML="Delete",a.classList.add("btn","delete"),t.prepend(a),t.addEventListener("submit",(async a=>{a.preventDefault();const n=new FormData(t);try{const t=await fetch("https://gallery.ddev.site/delete.php",{method:"POST",body:n}),a=await t.json();e.close(),removeDeletedImages(a)}catch(e){console.log(e)}}))},removeDeletedImages=function(e){e.forEach((e=>{let t=e.split("/"),a=t.pop();a=a.split(".")[0];let n="gallery-"+t.pop()+"_"+a,r=document.getElementById(n).parentElement;if(currentImage.id==n){let e=r.nextElementSibling;console.log(e),e=e?r.nextElementSibling:r.previousElementSibling,currentImage=e.querySelector("a")}r.style.setProperty("--delete-animation-duration","500ms"),r.classList.add("deleted"),setTimeout((()=>{r.remove(),currentImage.focus()}),500)}))},initAlbums=function(e){currentImage=e.querySelector("a"),currentImage.focus();let t=calcColumns(e);window.addEventListener("resize",(function(){t=calcColumns(e)}),!1),navigation(e,t)},initGallery=function(e){currentImage=e.querySelector("a"),currentImage.focus();let t=calcColumns(e);window.addEventListener("resize",(function(){t=calcColumns(e)}),!1),navigation(e,t),createSlideshowOverlay(e),initMarkedImages(e),deleteMarkedImages()},initGalleryScript=function(){const e=document.getElementById("albums");if(e)return void initAlbums(e);const t=document.getElementById("gallery");t&&initGallery(t)};initGalleryScript();